<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>GRAFIK DATA</title>

    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback"
    />
    <link rel="stylesheet" href="plugins/fontawesome-free/css/all.min.css" />
    <link
      rel="stylesheet"
      href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css"
    />
    <link rel="stylesheet" href="dist/css/adminlte.min.css" />
    <style>
      #loadingIndicator {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(255, 255, 255, 0.8);
        z-index: 9999;
        text-align: center;
        padding-top: 20%;
      }

      #loadingIndicator img {
        width: 50px;
        height: 50px;
      }

      #loadingIndicator p {
        margin-top: 10px;
      }

      #barChart {
        width: 100%;
        height: auto;
        min-height: 300px;
      }

      .chartCard {
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      .chartBox {
        width: 100%;
        padding: 20px;
        border-radius: 20px;
        border: solid 3px rgba(255, 26, 104, 1);
        background: white;
        display: flex;
      }
      .colLarge {
        max-width: 100%;
        overflow-x: auto;
      }
      .box {
        width: 1200%;
        height: 500px;
      }
    </style>
  </head>
  <body class="hold-transition sidebar-mini layout-fixed">
    <div class="wrapper">
      <div id="loadingIndicator">
        <img src="dist/img/Pulse-1s-200px.gif" alt="Loading Spinner" />
        <p>Loading...</p>
      </div>

      <div
        class="preloader flex-column justify-content-center align-items-center"
      >
        <img
          class="animation__shake"
          src="dist/img/AdminLTELogo.png"
          alt="AdminLTELogo"
          height="60"
          width="60"
        />
      </div>

      <nav class="main-header navbar navbar-expand navbar-white navbar-light">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" data-widget="pushmenu" href="#" role="button"
              ><i class="fas fa-bars"></i
            ></a>
          </li>
          <li class="nav-item d-none d-sm-inline-block">
            <a href="#" class="nav-link">Home</a>
          </li>
        </ul>

        <ul class="navbar-nav ml-auto">

          <li class="nav-item">
            <a class="nav-link" data-widget="fullscreen" href="#" role="button">
              <i class="fas fa-expand-arrows-alt"></i>
            </a>
          </li>
          <li class="nav-item">
            <a
              class="nav-link"
              data-widget="control-sidebar"
              data-controlsidebar-slide="true"
              href="#"
              role="button"
            >
              <i class="fas fa-th-large"></i>
            </a>
          </li>
        </ul>
      </nav>

      <aside class="main-sidebar sidebar-dark-primary elevation-4">
        <div class="sidebar">
          <div class="user-panel mt-3 pb-3 mb-3 d-flex">
            <div class="image">
              <img
                src="dist/img/user2-160x160.jpg"
                class="img-circle elevation-2"
                alt="User Image"
              />
            </div>
            <div class="info">
              <a href="#" class="d-block">Piyoxz</a>
            </div>
          </div>


          <nav class="mt-2">
            <ul
              class="nav nav-pills nav-sidebar flex-column"
              data-widget="treeview"
              role="menu"
              data-accordion="false"
            >
              <li class="nav-item menu-open">
                <a href="#" class="nav-link active">
                  <i class="nav-icon fas fa-tachometer-alt"></i>
                  <p>
                    Dashboard
                    <i class="right fas fa-angle-left"></i>
                  </p>
                </a>
                <ul class="nav nav-treeview">
                  <li class="nav-item">
                    <a href="./main.html" class="nav-link active">
                      <i class="far fa-circle nav-icon"></i>
                      <p>GRAFIK</p>
                    </a>
                  </li>
                </ul>
              </li>
            </ul>
          </nav>
        </div>
      </aside>

      <div class="content-wrapper">
        <div class="content-header">
          <div class="container-fluid">
            <div class="row mb-2">
              <div class="col-sm-6">
                <h1 class="m-0">Dashboard</h1>
              </div>
              <div class="col-sm-6">
                <ol class="breadcrumb float-sm-right">
                  <li class="breadcrumb-item"><a href="#">Home</a></li>
                  <li class="breadcrumb-item active">Grafik Data</li>
                </ol>
              </div>
            </div>
            <div class="row mb-2">
              <div class="col-sm-6">
                <button
                  type="button"
                  class="btn btn-primary"
                  data-toggle="modal"
                  data-target="#advancedFilterModal"
                >
                  <i class="fas fa-filter"></i> Advanced Filter
                </button>
              </div>
            </div>
          </div>
        </div>

        <section class="content">
          <div class="container-fluid">
            <div class="row">
              <section class="col-lg-12 connectedSortable">
                <div class="card card-success">
                  <div class="card-header">
                    <h3 class="card-title">Rekap Laporan</h3>
                    <div class="card-tools">
                      <button
                        type="button"
                        class="btn btn-tool"
                        data-card-widget="collapse"
                      >
                        <i class="fas fa-minus"></i>
                      </button>
                      <button
                        type="button"
                        class="btn btn-tool"
                        data-card-widget="remove"
                      >
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </div>
                  <div class="card-body">
                    <div class="chart">
                      <canvas
                        id="barChart"
                        style="
                          min-height: 250px;
                          height: 250px;
                          max-height: 250px;
                          max-width: 100%;
                        "
                      ></canvas>
                      <div
                        id="noDataMessage"
                        style="
                          display: none;
                          position: absolute;
                          top: 50%;
                          left: 50%;
                          transform: translate(-50%, -50%);
                        "
                      >
                        No data available
                      </div>
                    </div>
                  </div>
                </div>
              </section>
            </div>
            <div class="row">
              <section class="col-lg-12 connectedSortable">
                <div class="card card-success">
                  <div class="card-header">
                    <h3 class="card-title">Rekap Perbandingan</h3>
                    <div class="card-tools">
                      <button
                        type="button"
                        class="btn btn-tool"
                        data-card-widget="collapse"
                      >
                        <i class="fas fa-minus"></i>
                      </button>
                      <button
                        type="button"
                        class="btn btn-tool"
                        data-card-widget="remove"
                      >
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </div>
                  <div class="card-body">
                    <div class="chartCard">
                      <div class="chartBox">
                        <div class="colLarge">
                          <div class="box">
                            <canvas id="myChart1"></canvas>
                            <div
                              id="noDataMessage2"
                              style="
                                display: none;
                                position: absolute;
                                top: 50%;
                                left: 50%;
                                transform: translate(-50%, -50%);
                              "
                            >
                              No data available
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </section>
            </div>
            <div class="row">
              <section class="col-lg-12 connectedSortable">
                <div class="card card-success">
                  <div class="card-header">
                    <h3 class="card-title">Rekap Data Terlambat</h3>
                    <div class="card-tools">
                      <button
                        type="button"
                        class="btn btn-tool"
                        data-card-widget="collapse"
                      >
                        <i class="fas fa-minus"></i>
                      </button>
                      <button
                        type="button"
                        class="btn btn-tool"
                        data-card-widget="remove"
                      >
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                  </div>
                  <div class="card-body">
                    <div class="chart">
                      <canvas
                        id="terlambatByAreaChart"
                        style="
                          min-height: 250px;
                          height: 250px;
                          max-height: 250px;
                          max-width: 100%;
                        "
                      ></canvas>
                      <div
                        id="noDataMessage3"
                        style="
                          display: none;
                          position: absolute;
                          top: 50%;
                          left: 50%;
                          transform: translate(-50%, -50%);
                        "
                      >
                        No data available
                      </div>
                    </div>
                  </div>
                </div>
              </section>
            </div>
          </div>
        </section>
      </div>
    </div>

    <div
      class="modal fade"
      id="advancedFilterModal"
      tabindex="-1"
      role="dialog"
      aria-labelledby="advancedFilterModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="advancedFilterModalLabel">
              Advanced Filter
            </h5>
            <button
              type="button"
              class="close"
              data-dismiss="modal"
              aria-label="Close"
            >
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <form id="advancedFilterForm">
              <div class="form-group">
                <label for="tahunFilter">Filter by Year:</label>
                <select
                  class="form-control"
                  id="tahunFilter"
                  name="tahun"
                ></select>
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-secondary"
              data-dismiss="modal"
            >
              Close
            </button>
            <button
              type="button"
              class="btn btn-primary"
              onclick="applyAdvancedFilter()"
            >
              Apply Filter
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="plugins/jquery/jquery.min.js"></script>
    <script src="plugins/jquery-ui/jquery-ui.min.js"></script>
    <script>
      $.widget.bridge("uibutton", $.ui.button);
    </script>
    <script src="plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="plugins/chart.js/Chart.min.js"></script>
    <script src="dist/js/adminlte.js"></script>
    <script src="dist/js/pages/dashboard.js"></script>

    <script>
      let formFilter = {
        tahun: "semua",
      };
      let itemsTable = [];
      let barChart = null;
      let bandingChart = null;
      let terlambat = null;
      const data1 = document.getElementById("noDataMessage");
      const data2 = document.getElementById("noDataMessage2");
      const data3 = document.getElementById("noDataMessage3");
    </script>

    <script type="text/javascript">
      $(document).ready(async function () {
        $("#loadingIndicator").show();
        try {
          await loadDaftar();
          await createBarChart();
          await createComparisonTable();
          await createTerlambatByAreaChart();
        } catch (error) {
          console.error("Error:", error);
        } finally {
          $("#loadingIndicator").hide();
        }
      });
    </script>

    <script>
      async function loadDaftar() {
        try {
          const response = await fetch(
            `https://automatic-acorn-r5vg554j76x25wwr-3000.app.github.dev/api/daftardashboard?tahun=${formFilter.tahun}`,
            {
              method: "GET",
              headers: {
                "Content-Type": "application/json",
              },
            }
          );
          const data = await response.json();
          $("#titlelaporantahun").text("Laporan Tahun " + formFilter.tahun);
          itemsTable = data.data;
        } catch (error) {
          console.error("Error loading data:", error);
          throw error;
        }
      }
    </script>
    <script>
      async function applyAdvancedFilter() {
        barChart.destroy();
        bandingChart.destroy();
        terlambat.destroy();
        $("#advancedFilterModal").modal("hide");
        $("#loadingIndicator").show();
        formFilter.tahun = $("#tahunFilter").val();
        await loadDaftar();
        if (itemsTable && itemsTable.length) {
          await createBarChart();
          await createComparisonTable();
          await createTerlambatByAreaChart();
          data1.style.display = "none";
          data2.style.display = "none";
          data3.style.display = "none";
        } else {
          data1.style.display = "block";
          data2.style.display = "block";
          data3.style.display = "block";
        }
        $("#loadingIndicator").hide();
      }

      document.addEventListener("DOMContentLoaded", function () {
        const currentYear = new Date().getFullYear();
        const selectElement = document.getElementById("tahunFilter");

        for (let year = currentYear - 3; year <= currentYear + 10; year++) {
          const option = document.createElement("option");
          option.value = year.toString();
          option.text = year.toString();
          selectElement.appendChild(option);
        }

        let optionSemua = document.createElement("option");
        optionSemua.value = "semua";
        optionSemua.text = "Semua";
        selectElement.appendChild(optionSemua);

        $("#tahunFilter").val("semua");
        formFilter.tahun = "semua";
      });
    </script>

    <script type="text/javascript">
      function createBarChart() {
        const laporanCount = {};

        let data = itemsTable;

        data.forEach((item) => {
          const laporan = String(item.laporan);
          if (laporanCount[laporan]) {
            laporanCount[laporan]++;
          } else {
            laporanCount[laporan] = 1;
          }
        });

        const labels = Object.keys(laporanCount);
        const dataValues = Object.values(laporanCount);

        const ctx = document.getElementById("barChart").getContext("2d");

        barChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Jumlah Laporan",
                data: dataValues,
                backgroundColor: "rgba(54, 162, 235, 0.5)",
                borderColor: "rgba(54, 162, 235, 1)",
                borderWidth: 1,
                barPercentage: 0.8 + Math.random() * 0.2,
              },
            ],
          },
          options: {
            maintainAspectRatio: false,
            scales: {
              y: {
                stacked: false,
              },
              x: {
                stacked: false,
              },
              yAxes: [
                {
                  ticks: {
                    beginAtZero: true,
                  },
                },
              ],
            },
          },
        });
      }

      function getRandomColor() {
        const letters = "0123456789ABCDEF";
        let color = "#";
        for (let i = 0; i < 6; i++) {
          color += letters[Math.floor(Math.random() * 16)];
        }
        return color;
      }

      function createComparisonTable() {
        const comparisonData = {};

        let datax = itemsTable;

        datax.forEach((item) => {
          const area = item.area;
          const laporan = item.laporan;

          if (!comparisonData[area]) {
            comparisonData[area] = {};
          }

          if (!comparisonData[area][laporan]) {
            comparisonData[area][laporan] = 0;
          }

          comparisonData[area][laporan]++;
        });

        const labels = Object.keys(comparisonData);

        const allLaporan = new Set();
        Object.values(comparisonData).forEach((areaData) => {
          Object.keys(areaData).forEach((laporan) => {
            allLaporan.add(laporan);
          });
        });

        const colorMap = {
          "Briefing Pagi": "rgba(255, 26, 104, 0.2)",
          Lunch: "rgba(54, 162, 235, 0.2)",
          "coffe break": "rgba(255, 206, 86, 0.2)",
        };

        const borderMap = {
          "Briefing Pagi": "rgba(255, 26, 104, 1)",
          Lunch: "rgba(54, 162, 235, 1)",
          "coffe break": "rgba(255, 206, 86, 1)",
        };

        const datasets = [];
        allLaporan.forEach((laporan) => {
          const data = labels.map((area) => comparisonData[area][laporan] || 0);
          datasets.push({
            label: laporan,
            data: data,
            backgroundColor: colorMap[laporan] || "rgba(0, 0, 0, 0.2)",
            borderWidth: 1,
            borderColor: "rgba(75, 192, 192, 1)",
          });
        });

        const ctx = document.getElementById("myChart1").getContext("2d");
        bandingChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: labels,
            datasets: datasets,
          },
          options: {
            maintainAspectRatio: false,
            layout: {
              padding: {
                bottom: 28,
              },
            },
            scales: {
              yAxes: [
                {
                  ticks: {
                    beginAtZero: true,
                  },
                },
              ],
              y: {
                beginAtZero: true,
                afterFit: (ctx) => {
                  ctx.width = 35;
                },
              },
              x: {
                ticks: {
                  display: false,
                },
                grid: {
                  drawTicks: false,
                },
              },
            },
            plugins: {
              legend: {
                display: false,
              },
            },
          },
        });
      }
      function createTerlambatByAreaChart() {
        const terlambatByArea = {};
        itemsTable.forEach((item) => {
          const area = item.area;
          if (!terlambatByArea[area]) {
            terlambatByArea[area] = 0;
          }
          if (item["KATEGORI"] === "TERLAMBAT") {
            terlambatByArea[area]++;
          }
        });

        const labels = Object.keys(terlambatByArea);
        const dataValues = Object.values(terlambatByArea);

        const ctx = document
          .getElementById("terlambatByAreaChart")
          .getContext("2d");
        terlambat = new Chart(ctx, {
          type: "line",
          data: {
            labels: labels,
            datasets: [
              {
                label: "Jumlah Terlambat",
                data: dataValues,
                fill: true,
                backgroundColor: "rgba(255, 99, 132, 0.2)",
                borderColor: "rgba(255, 99, 132, 1)",
                borderWidth: 1,
              },
            ],
          },
          options: {
            maintainAspectRatio: false,
            scales: {
              yAxes: [
                {
                  ticks: {
                    beginAtZero: true,
                  },
                },
              ],
              y: {
                beginAtZero: true,
                afterFit: (ctx) => {
                  ctx.width = 35;
                },
              },
              x: {
                ticks: {
                  display: false,
                },
                grid: {
                  drawTicks: false,
                },
              },
            },
            plugins: {
              legend: {
                display: false,
              },
            },
          },
        });
      }
    </script>
  </body>
</html>
